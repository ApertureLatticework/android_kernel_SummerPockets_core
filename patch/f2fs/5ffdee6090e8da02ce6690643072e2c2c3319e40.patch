From 5ffdee6090e8da02ce6690643072e2c2c3319e40 Mon Sep 17 00:00:00 2001
From: Kinaxie <huanying1194139625@gmail.com>
Date: Wed, 25 Jun 2025 00:02:14 +0900
Subject: [PATCH] f2fs: optimize device comparison in IO path This commit
 improves the block device comparison logic by:

1. Using bio_dev() for direct device number comparison instead of
   separate disk/partition checks
2. Reducing pointer dereferences in the hot IO path
3. Simplifying the conditional check

The optimization is expected to:
- Reduce CPU cycles for each IO operation
- Improve pipeline efficiency in high IOPS scenarios
- Maintain identical functionality

While actual performance improvement needs verification, the change
provides cleaner code with potential for better IO throughput.

Signed-off-by: Kinaxie <huanying1194139625@gmail.com>
Signed-off-by: Cloud_Yun <1770669041@qq.com>
---
 fs/f2fs/data.c | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/fs/f2fs/data.c b/fs/f2fs/data.c
index f2095d59a8d6..99a690d48b37 100644
--- a/fs/f2fs/data.c
+++ b/fs/f2fs/data.c
@@ -459,6 +459,16 @@ static blk_opf_t f2fs_io_flags(struct f2fs_io_info *fio)
 	return op_flags;
 }
 
+/*
+ * Return true, if pre_bio's bdev is same as its target device.
+ */
+static bool __same_bdev(struct f2fs_sb_info *sbi,
+                                block_t blk_addr, struct bio *bio)
+{
+	struct block_device *b = f2fs_target_device(sbi, blk_addr, NULL);
+	return bio_dev(bio) == b->bd_dev;
+}
+
 static struct bio *__bio_alloc(struct f2fs_io_info *fio, int npages)
 {
 	struct f2fs_sb_info *sbi = fio->sbi;
@@ -782,7 +792,7 @@ static bool page_is_mergeable(struct f2fs_sb_info *sbi, struct bio *bio,
 		return false;
 	if (last_blkaddr + 1 != cur_blkaddr)
 		return false;
-	return bio->bi_bdev == f2fs_target_device(sbi, cur_blkaddr, NULL);
+	return __same_bdev(sbi, cur_blkaddr, bio);
 }
 
 static bool io_type_is_mergeable(struct f2fs_bio_info *io,
